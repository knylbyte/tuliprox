---
name: Rust Bump trunk & wasm-bindgen-cli

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"

permissions:
  contents: write
  actions: write

jobs:
  check-and-bump:
    runs-on: ubuntu-latest
    env:
      FILE: docker/build-tools/rust-wasm-tools.Dockerfile
      UA: "tuliprox-bump-bot/1.0 (+https://github.com/${{ github.repository_owner }}/tuliprox)"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get current versions from Dockerfile
        id: current
        shell: bash
        run: |
          set -euo pipefail

          trunk_current="$(grep -Eo 'ARG TRUNK_VER=([0-9]+\.[0-9]+\.[0-9]+)' "$FILE" | cut -d= -f2)"
          bindgen_current="$(grep -Eo 'ARG BINDGEN_VER=([0-9]+\.[0-9]+\.[0-9]+)' "$FILE" | cut -d= -f2)"

          echo "trunk_current=$trunk_current" >> "$GITHUB_OUTPUT"
          echo "bindgen_current=$bindgen_current" >> "$GITHUB_OUTPUT"

      - name: Fetch latest versions
        id: latest
        shell: bash
        run: |
          set -euo pipefail

          get_latest_from_api () {
            local crate="$1"
            curl -fsSL \
              -H "User-Agent: $UA" \
              -H "Accept: application/json" \
              --retry 3 --retry-delay 2 --retry-connrefused \
              "https://crates.io/api/v1/crates/${crate}" \
            | jq -r '.crate.max_stable_version'
          }

          trunk_latest="$(get_latest_from_api trunk || true)"
          bindgen_latest="$(get_latest_from_api wasm-bindgen-cli || true)"

          [[ -n "${trunk_latest:-}" && "${trunk_latest}" != "null" ]]
          [[ -n "${bindgen_latest:-}" && "${bindgen_latest}" != "null" ]]

          echo "trunk_latest=$trunk_latest" >> "$GITHUB_OUTPUT"
          echo "bindgen_latest=$bindgen_latest" >> "$GITHUB_OUTPUT"

      - name: Show versions
        run: |
          echo "Current -> trunk=${{ steps.current.outputs.trunk_current }}, wasm-bindgen-cli=${{ steps.current.outputs.bindgen_current }}"
          echo "Latest  -> trunk=${{ steps.latest.outputs.trunk_latest }}, wasm-bindgen-cli=${{ steps.latest.outputs.bindgen_latest }}"

      - name: Update Dockerfile if newer versions found
        id: update
        shell: bash
        run: |
          set -euo pipefail

          updated=false

          if [ "${{ steps.latest.outputs.trunk_latest }}" != "${{ steps.current.outputs.trunk_current }}" ]; then
            sed -i -E "s/^(ARG TRUNK_VER=).*/\1${{ steps.latest.outputs.trunk_latest }}/" "$FILE"
            updated=true
          fi

          if [ "${{ steps.latest.outputs.bindgen_latest }}" != "${{ steps.current.outputs.bindgen_current }}" ]; then
            sed -i -E "s/^(ARG BINDGEN_VER=).*/\1${{ steps.latest.outputs.bindgen_latest }}/" "$FILE"
            updated=true
          fi

          echo "updated=$updated" >> "$GITHUB_OUTPUT"

          if [ "$updated" -eq 0 ]; then
            echo "Nothing to do. Running the latest version trunk=${{ steps.latest.outputs.trunk_latest }}, bindgen=${{ steps.latest.outputs.bindgen_latest }}"
          fi

      - name: Commit & push
        if: steps.update.outputs.updated == 'true'
        shell: bash
        run: |
          set -euo pipefail
          branch="${{ github.event.repository.default_branch }}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$FILE"
          git commit -m "chore(build-tools): bump trunk to ${{ steps.latest.outputs.trunk_latest }} and wasm-bindgen-cli to ${{ steps.latest.outputs.bindgen_latest }}"
          git push origin "HEAD:${branch}"

      - name: Build new Rust Wasm Prebuild Image
        if: steps.update.outputs.updated == 'true'
        env: 
          GH_TOKEN: ${{ github.token }}
        run: |
          gh workflow run rust-wasm-tools-prebuild.yml