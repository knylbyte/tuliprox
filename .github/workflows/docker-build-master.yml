name: Docker Build (master)

on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: docker-build-master
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  actions: write

env:
  GHCR_NS: ghcr.io/${{ github.repository }}
  DOCKERFILE: docker/ci.Dockerfile

jobs:
  prebuilds:
    name: Ensure tuliprox build tools exist
    runs-on: ubuntu-24.04
    outputs:
      need_build_tools: ${{ steps.check.outputs.need_build_tools }}
      archs: ${{ steps.arch.outputs.archs }}

    steps:
      - name: Step 1.1 - Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Step 1.2 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 1.3 - Set arch list
        id: arch
        shell: bash
        run: |
          set -euo pipefail
          echo "archs=linux-amd64 linux-arm64 linux-armv7" >> "$GITHUB_OUTPUT"

      - name: Step 1.4 - Check prebuild availability (all archs)
        id: check
        shell: bash
        env:
          BUILD_TOOLS_IMAGE: ${{ env.GHCR_NS }}/tuliprox-build-tools
        run: |
          set -euo pipefail
          need_build_tools=false
          for arch in ${{ steps.arch.outputs.archs }}; do
            if ! docker buildx imagetools inspect "${BUILD_TOOLS_IMAGE}:${arch}" >/dev/null 2>&1; then
              need_build_tools=true
            fi
          done
          echo "need_build_tools=$need_build_tools" >> "$GITHUB_OUTPUT"

      - name: Step 1.5 - Summary (tuliprox build tools check)
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ› ï¸ tuliprox-build-tools"
            if [[ "${{ steps.check.outputs.need_build_tools }}" == "true" ]]; then
              echo "âš ï¸ tuliprox-build-tools images missing for at least one architecture."
              echo "- A dedicated build job will run before the Docker build."
            else
              echo "âœ… All required prebuilds already present."
            fi
            echo ""
            echo "### ðŸ“¦ Tags checked"
            for a in ${{ steps.arch.outputs.archs }}; do
              echo "- \`${{ env.GHCR_NS }}/tuliprox-build-tools:${a}\`"
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Step 1.6 - Build tuliprox-build-tools if needed
        if: steps.check.outputs.need_build_tools == 'true'
        run: |
          gh workflow run docker-build-tuliprox-build-tools.yml --ref ${{ github.ref }} --repo ${{ github.repository }} --field trigger=gh-actions
          exit 1

  build:
    name: Build & Publish - Master
    needs:
      - prebuilds
    outputs:
      version: ${{ steps.version.outputs.version }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch_tag: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch_tag: linux-arm64
          # - platform: linux/arm/v7
          #   runner: ubuntu-24.04-arm
          #   arch_tag: linux-armv7
    runs-on: ${{ matrix.runner || 'ubuntu-24.04' }}
    env:
      CARGO_HOME: /usr/local/cargo
      SCCACHE_DIR: /var/cache/sccache

    steps:
      - name: Step 2.1 - Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Step 2.2 - Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.3 - Set up Buildx
        uses: docker/setup-buildx-action@v3
        id: setup-buildx
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.4 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 2.5 - Read version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          ver="$(grep -Eom1 '^# [0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | awk '{print $2}')"
          if [[ -z "${ver:-}" ]]; then
            echo "Failed to parse version from CHANGELOG.md" >&2
            exit 1
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Step 2.8 - Ensure cache context dir
        run: mkdir -p .ci-cache/${{ matrix.arch_tag }} /tmp/.ci-cache/${{ matrix.arch_tag }}

      - name: Step 2.9 - Load cargo chef and sccache directories for Docker build
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            .ci-cache/${{ matrix.arch_tag }}
          key: ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-

      - name: Step 2.10 - Build cache-export TARs (${{ matrix.platform }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: ${{ matrix.platform }}
          push: false
          build-contexts: |
            cache=./.ci-cache/${{ matrix.arch_tag }}
          outputs: |
            type=local,dest=/tmp/.ci-cache/${{ matrix.arch_tag }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            GHCR_NS=${{ env.GHCR_NS }}
            BUILDPLATFORM_TAG=${{ matrix.arch_tag }}
            CARGO_HOME=${{ env.CARGO_HOME }}
            SCCACHE_DIR=${{ env.SCCACHE_DIR }}
          target: cache-export
          cache-from: |
            type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}
            type=registry,ref=${{ env.GHCR_NS }}:dev-${{ matrix.arch_tag }}
          cache-to: |
            type=gha,scope=dev-cache-export-${{ matrix.arch_tag }},mode=max

      - name: Step 2.11 - Move cache TARs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          find /tmp/.ci-cache/${{ matrix.arch_tag }} -name '*.tar' -maxdepth 3 -exec mv {} .ci-cache/${{ matrix.arch_tag }}/ \;
          ls -al .ci-cache/${{ matrix.arch_tag }}
          rm -rf /tmp/.ci-cache/${{ matrix.arch_tag }}

      - name: Step 2.12 - Build scratch-final image (${{ matrix.platform }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: ${{ matrix.platform }}
          push: true
          build-contexts: |
            cache=./.ci-cache/${{ matrix.arch_tag }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            GHCR_NS=${{ env.GHCR_NS }}
            BUILDPLATFORM_TAG=${{ matrix.arch_tag }}
            CARGO_HOME=${{ env.CARGO_HOME }}
            SCCACHE_DIR=${{ env.SCCACHE_DIR }}
          target: scratch-final
          tags: dev-slim-${{ steps.version.outputs.version  }}-${{ matrix.arch_tag }}
          cache-from: |
            type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}
            type=registry,ref=${{ env.GHCR_NS }}:dev

      - name: Step 2.14 - Build alpine-final image (${{ matrix.platform }})
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          platforms: ${{ matrix.platform }}
          push: true
          build-contexts: |
            cache=./.ci-cache/${{ matrix.arch_tag }}
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            GHCR_NS=${{ env.GHCR_NS }}
            BUILDPLATFORM_TAG=${{ matrix.arch_tag }}
            CARGO_HOME=${{ env.CARGO_HOME }}
            SCCACHE_DIR=${{ env.SCCACHE_DIR }}
          target: alpine-final
          tags: dev-${{ steps.version.outputs.version  }}-${{ matrix.arch_tag }}
          cache-from: |
            type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}
            type=registry,ref=${{ env.GHCR_NS }}:dev

      - name: Step 2.16 - Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ§± Build Summary"
            echo ""
            echo "### ðŸ”– Version"
            echo "- CHANGELOG version: **${{ steps.version.outputs.version }}**"
            echo ""
            echo "### ðŸ·ï¸ Published tags"
            echo "- \`${{ env.GHCR_NS }}:dev-slim-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}\`"
            echo "- \`${{ env.GHCR_NS }}:dev-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}\`"
            echo ""
            echo "### ðŸ§· Cache"
            echo "- cache-from: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}\`"
            echo "- cache-from: \`type=registry,ref=${{ env.GHCR_NS }}:dev\`"
            echo "- cache-export cache-to: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }},mode=max\`"
            echo ""
            echo "### ðŸ§­ Platforms"
            echo "- ${{ matrix.platform }}"
          } >> "$GITHUB_STEP_SUMMARY"
  manifests:
    name: Manifests
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - name: Step 3.1 - Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Step 3.2 - GHCR Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 3.3 - Create manifests
        id: create
        shell: bash
        run: |
          set -euo pipefail

          TAGS_INPUT='${{ needs.build.outputs.tags }}'
          ARCHES_INPUT='${{ needs.build.outputs.arches }}'

          readarray -t TAGS <<< "$TAGS_INPUT"
          read -r -a ARCHES <<< "$ARCHES_INPUT"

          if [[ ${#TAGS[@]} -eq 0 || -z "${TAGS[0]// }" ]]; then
            echo "No tags to publish"
            exit 0
          fi

          make_manifest() {
            local tag="$1"
            local src=()
            for arch in "${ARCHES[@]}"; do
              src+=( "${GHCR_NS}:${tag}-${arch}" )
            done
            echo "â›ï¸  Creating manifest ${GHCR_NS}:${tag}"
            docker buildx imagetools create -t "${GHCR_NS}:${tag}" "${src[@]}"
          }

          for t in "${TAGS[@]}"; do
            [[ -n "${t// }" ]] || continue
            make_manifest "$t"
          done

      - name: Step 3.4 - Summary (manifests)
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ“š Multi-arch manifests"
            echo ""
            if [[ "${{ steps.create.outcome }}" == "success" ]]; then
              echo "âœ… All requested manifests were created."
            else
              echo "âŒ Manifest creation encountered an error."
            fi
            echo ""
            echo "### ðŸ·ï¸ Final tags"
            TAGS_INPUT='${{ needs.build.outputs.tags }}'
            if [[ -n "$TAGS_INPUT" ]]; then
              while IFS= read -r line; do
                [[ -n "${line// }" ]] || continue
                image="${GHCR_NS}:${line}"
                digest=""
                if info="$(docker buildx imagetools inspect "$image" 2>/dev/null)"; then
                  digest="$(awk '/^Digest:/ {print $2; exit}' <<< "$info")"
                fi
                echo "- \`$image\`"
                if [[ -n "$digest" ]]; then
                  if [[ "$digest" == sha256:* ]]; then
                    echo "  - sha256: \`${digest#sha256:}\`"
                  else
                    echo "  - digest: \`$digest\`"
                  fi
                else
                  echo "  - sha256: *(lookup failed)*"
                fi
              done <<< "$TAGS_INPUT"
            else
              echo "- (none)"
            fi
            echo ""
            echo "### ðŸ§© Architectures"
            for a in ${{ needs.build.outputs.arches }}; do
              echo "- ${a}"
            done
            echo ""
            echo "### ðŸ“¦ Registry"
            echo "- ghcr.io"
          } >> "$GITHUB_STEP_SUMMARY"
