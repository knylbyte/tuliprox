name: Docker Build & Push (develop)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

concurrency:
  group: docker-build-develop
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  actions: write

env:
  GHCR_NS: ghcr.io/${{ github.repository }}
  DOCKERFILE: docker/ci.Dockerfile

jobs:
  prebuilds:
    name: Ensure tuliprox build tools exist
    runs-on: ubuntu-24.04
    outputs:
      need_build_tools: ${{ steps.check.outputs.need_build_tools }}
      archs: ${{ steps.arch.outputs.archs }}

    steps:
      - name: Step 1.1 - Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Step 1.2 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 1.3 - Set arch list
        id: arch
        shell: bash
        run: |
          set -euo pipefail
          echo "archs=linux-amd64 linux-arm64 linux-armv7" >> "$GITHUB_OUTPUT"

      - name: Step 1.4 - Check prebuild availability (all archs)
        id: check
        shell: bash
        env:
          BUILD_TOOLS_IMAGE: ${{ env.GHCR_NS }}/tuliprox-build-tools
        run: |
          set -euo pipefail
          need_build_tools=false
          for arch in ${{ steps.arch.outputs.archs }}; do
            if ! docker buildx imagetools inspect "${BUILD_TOOLS_IMAGE}:${arch}" >/dev/null 2>&1; then
              need_build_tools=true
            fi
          done
          echo "need_build_tools=$need_build_tools" >> "$GITHUB_OUTPUT"

      - name: Step 1.5 - Summary (tuliprox build tools check)
        if: always()
        shell: bash
        run: |
          {
            echo "## üõ†Ô∏è tuliprox-build-tools"
            if [[ "${{ steps.check.outputs.need_build_tools }}" == "true" ]]; then
              echo "‚ö†Ô∏è tuliprox-build-tools images missing for at least one architecture."
              echo "- A dedicated build job will run before the Docker build."
            else
              echo "‚úÖ All required prebuilds already present."
            fi
            echo ""
            echo "### üì¶ Tags checked"
            for a in ${{ steps.arch.outputs.archs }}; do
              echo "- \`${{ env.GHCR_NS }}/tuliprox-build-tools:${a}\`"
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Step 1.6 - Build tuliprox-build-tools if needed
        if: steps.check.outputs.need_build_tools == 'true'
        run: |
          gh workflow run docker-build-tuliprox-build-tools.yml --ref ${{ github.ref }} --repo ${{ github.repository }} --field trigger=gh-actions
          exit 1

  build:
    name: Build & Publish - Develop
    needs:
      - prebuilds
    outputs:
      version: ${{ steps.version.outputs.version }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch_tag: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch_tag: linux-arm64
          # - platform: linux/arm/v7
          #   runner: ubuntu-24.04-arm
          #   arch_tag: linux-armv7
    runs-on: ${{ matrix.runner || 'ubuntu-24.04' }}

    steps:
      - name: Step 2.1 - Checkout
        uses: actions/checkout@v5

      - name: Step 2.2 - Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.3 - Set up Buildx
        uses: docker/setup-buildx-action@v3
        id: setup-buildx
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.4 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 2.5 - Read version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          ver="$(grep -Eom1 '^# [0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | awk '{print $2}')"
          if [[ -z "${ver:-}" ]]; then
            echo "Failed to parse version from CHANGELOG.md" >&2
            exit 1
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Step 2.6 - Prepare cache context directory
        run: mkdir -p ${{ github.workspace }}/.ci-cache/${{ matrix.arch_tag }} ${{ runner.temp }}/.ci-cache/${{ matrix.arch_tag }}

      - name: Step 2.7 - Prepare image artifact directory
        run: mkdir -p ${{ github.workspace }}/.ci-artifacts/${{ matrix.arch_tag }}

      - name: Step 2.8 - Load cache directories for Docker build
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            .ci-cache/${{ matrix.arch_tag }}
          key: ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-

      - name: Step 2.9 - Resolve Bake targets
        id: bake-targets
        shell: bash
        run: |
          {
            echo 'targets<<EOF'
            echo 'cache-export'
            echo 'scratch-final'
            echo 'alpine-final'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Step 2.10 - Build images with docker buildx bake (debug)
        id: build
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          ARCH_TAG: ${{ matrix.arch_tag }}
          PLATFORM: ${{ matrix.platform }}
          VERSION: ${{ steps.version.outputs.version }}
          DOCKER_BAKE_METADATA_DEST: ${{ github.workspace }}/.ci-artifacts/${{ matrix.arch_tag }}
          CACHE_CONTEXT: ${{ github.workspace }}/.ci-cache/${{ matrix.arch_tag }}
          CACHE_DEST: ${{ runner.temp }}/.ci-cache/${{ matrix.arch_tag }}
          BUILDKIT_PROGRESS: plain
        run: |
          set -euo pipefail
          echo "Cache contents before build:"
          ls -al ${CACHE_CONTEXT}
          
          targets="${{ steps.bake-targets.outputs.targets }}"
          echo "Targets (raw):"
          printf '  %s\n' "$targets"
          mapfile -t target_list <<<"$targets"
          
          echo "Running docker buildx bake with ${#target_list[@]} targets: ${target_list[*]}"
          docker buildx bake \
            --file docker/docker-bake.hcl \
            --allow=fs.write=${DOCKER_IMAGE_DEST} \
            --allow=fs.write=${CACHE_DEST} \
            --allow=fs.read=${CACHE_CONTEXT} \
            --metadata-file "${DOCKER_BAKE_METADATA_DEST}/metadata.json" \
            --load \
            --progress plain \
            "${target_list[@]}"

      - name: Step 2.11 - Move cache TARs
        shell: bash
        run: |
          set -euo pipefail
          find ${{ runner.temp }}/.ci-cache/${{ matrix.arch_tag }} -name '*.tar' -maxdepth 3 -exec mv {} .ci-cache/${{ matrix.arch_tag }}/ \;
          ls -al ${{ github.workspace }}/.ci-cache/${{ matrix.arch_tag }}
          rm -rf ${{ runner.temp }}/.ci-cache/${{ matrix.arch_tag }}
      
      # - name: print outputs
      #   run: ls -al .ci-artifacts/${{ matrix.arch_tag }}

      # - name: Step 2.13 - Upload image artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dev-images-${{ matrix.arch_tag }}
      #     path: .ci-artifacts/${{ matrix.arch_tag }}
      #     if-no-files-found: error
      
      - name: Step 2.12 - Export digests
        id: export-digests
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          VERSION: ${{ steps.version.outputs.version }}
          ARCH_TAG: ${{ matrix.arch_tag }}
          PLATFORM: ${{ matrix.platform }}
          METADATA_FILE: ${{ github.workspace }}/.ci-artifacts/${{ matrix.arch_tag }}/metadata.json
        run: |
          set -euo pipefail
          if [[ ! -s "${METADATA_FILE}" ]]; then
            echo "Metadata file missing or empty: ${METADATA_FILE}" >&2
            ls -al "$(dirname "${METADATA_FILE}")" >&2 || true
            exit 1
          fi

          digest_root="${{ runner.temp }}/digests"
          mkdir -p "${digest_root}"

          mapfile -t entries < <(
            jq -r '
              .target
              | to_entries[]
              | select(.value."containerimage.digest")
              | [.key, .value."containerimage.digest"]
              | @tsv
            ' "${METADATA_FILE}"
          )

          if [[ ${#entries[@]} -eq 0 ]]; then
            echo "No digest entries discovered in ${METADATA_FILE}" >&2
            exit 1
          fi

          for entry in "${entries[@]}"; do
            IFS=$'\t' read -r target digest <<<"${entry}"
            case "${target}" in
              alpine-final) variant="dev" ;;
              scratch-final) variant="dev-slim" ;;
              *)
                echo "Skipping unhandled bake target: ${target}" >&2
                continue
                ;;
            esac

            variant_dir="${digest_root}/${variant}"
            mkdir -p "${variant_dir}"

            source_tag="${variant}-${VERSION}-${ARCH_TAG}"
            ref="${GHCR_NS}:${source_tag}@${digest}"
            cat <<EOF > "${variant_dir}/${ARCH_TAG}.json"
            {
              "variant": "${variant}",
              "arch_tag": "${ARCH_TAG}",
              "platform": "${PLATFORM}",
              "version": "${VERSION}",
              "source_tag": "${source_tag}",
              "digest": "${digest}",
              "ref": "${ref}"
            }
            EOF
          done

          echo "Digest metadata files:"
          find "${digest_root}" -type f -print

      - name: Step 2.13 - Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch_tag }}
          path: ${{ runner.temp }}/digests
          if-no-files-found: error
          retention-days: 1

      - name: Step 2.14 - Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## üß± Build Summary"
            echo ""
            echo "### üîñ Version"
            echo "- CHANGELOG version: **${{ steps.version.outputs.version }}**"
            echo ""
            echo "### üì¶ Exported artifacts"
            echo "- dev-slim-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }} (DOCKER image)"
            echo "- dev-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }} (DOCKER image)"
            echo ""
            echo "### üß∑ Cache"
            echo "- cache-from: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}\`"
            echo "- cache-from: \`type=registry,ref=${{ env.GHCR_NS }}:dev\`"
            echo "- cache-to: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }},mode=max\`"
            echo ""
            echo "### üß≠ Platforms"
            echo "- ${{ matrix.platform }}"
          } >> "$GITHUB_STEP_SUMMARY"
  
  manifests:
    name: Manifests
    needs:
      - prebuilds
      - build
    runs-on: ubuntu-24.04

    steps:
      - name: Step 3.1 - Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Step 3.2 - GHCR Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # - name: Step 3.3 - Download image artifacts
      #   uses: actions/download-artifact@v4
      #   with:
      #     pattern: dev-images-*
      #     path: .ci-artifacts
      #     merge-multiple: false

      - name: Step 3.3 - Download digests
        uses: actions/download-artifact@v4
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - name: Step 3.4 - Create and publish manifests
        id: create
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          VERSION: ${{ needs.build.outputs.version }}
          DIGEST_ROOT: ${{ runner.temp }}/digests
        run: |
          set -euo pipefail

          if [[ ! -d "${DIGEST_ROOT}" ]]; then
            echo "Digest directory not found: ${DIGEST_ROOT}" >&2
            exit 1
          fi

          shopt -s nullglob

          declare -A variant_refs=()
          declare -A platform_seen=()
          declare -A variant_versions=()

          digest_files=("${DIGEST_ROOT}"/*/*.json "${DIGEST_ROOT}"/*.json)
          if [[ ${#digest_files[@]} -eq 0 ]]; then
            echo "No digest metadata files located under ${DIGEST_ROOT}" >&2
            exit 1
          fi

          for file in "${digest_files[@]}"; do
            [[ -f "${file}" ]] || continue
            variant=$(jq -r '.variant // empty' "${file}")
            ref=$(jq -r '.ref // empty' "${file}")
            platform=$(jq -r '.platform // empty' "${file}")
            file_version=$(jq -r '.version // empty' "${file}")
            if [[ -z "${variant}" || -z "${ref}" ]]; then
              echo "Skipping ${file} because variant or ref is missing" >&2
              continue
            fi

            if [[ -n "${file_version}" ]]; then
              variant_versions["${variant}"]="${file_version}"
            fi

            variant_refs["${variant}"]+="${ref} "
            if [[ -n "${platform}" ]]; then
              platform_seen["${platform}"]=1
            fi
          done

          if [[ ${#variant_refs[@]} -eq 0 ]]; then
            echo "No variant digests gathered from ${DIGEST_ROOT}" >&2
            exit 1
          fi

          tags_output=()
          digests_output=()

          for variant in "${!variant_refs[@]}"; do
            ref_string="${variant_refs[$variant]}"
            read -r -a refs <<<"${ref_string}"
            if [[ ${#refs[@]} -eq 0 ]]; then
              echo "Variant ${variant} has no digest refs" >&2
              exit 1
            fi

            version_to_use="${VERSION:-${variant_versions[${variant}]:-}}"

            create_args=()
            create_args+=(--tag "${GHCR_NS}:${variant}")
            if [[ -n "${version_to_use}" ]]; then
              create_args+=(--tag "${GHCR_NS}:${variant}-${version_to_use}")
            fi

            echo "Creating manifest for variant '${variant}' with refs:"
            printf '  - %s\n' "${refs[@]}"

            docker buildx imagetools create "${create_args[@]}" "${refs[@]}"

            for tag in "${GHCR_NS}:${variant}"; do
              tags_output+=("${tag#${GHCR_NS}:}")
              manifest_digest=$(docker buildx imagetools inspect "${tag}" | awk '/^Digest: / { print $2; exit }' || true)
              if [[ -n "${manifest_digest}" ]]; then
                digests_output+=("${tag#${GHCR_NS}:} ${manifest_digest}")
              fi
            done

            if [[ -n "${version_to_use}" ]]; then
              versioned_tag="${GHCR_NS}:${variant}-${version_to_use}"
              tags_output+=("${versioned_tag#${GHCR_NS}:}")
              manifest_digest=$(docker buildx imagetools inspect "${versioned_tag}" | awk '/^Digest: / { print $2; exit }' || true)
              if [[ -n "${manifest_digest}" ]]; then
                digests_output+=("${versioned_tag#${GHCR_NS}:} ${manifest_digest}")
              fi
            fi
          done

          # Unique tags while preserving order
          uniq_tags=()
          declare -A seen_tags=()
          for tag in "${tags_output[@]}"; do
            if [[ -n "${tag}" && -z "${seen_tags[$tag]:-}" ]]; then
              uniq_tags+=("${tag}")
              seen_tags["${tag}"]=1
            fi
          done

          uniq_digests=()
          declare -A seen_digests=()
          for entry in "${digests_output[@]}"; do
            if [[ -n "${entry}" && -z "${seen_digests[$entry]:-}" ]]; then
              uniq_digests+=("${entry}")
              seen_digests["${entry}"]=1
            fi
          done

          arches_output=()
          for platform in "${!platform_seen[@]}"; do
            arches_output+=("${platform}")
          done

          {
            echo 'tags<<EOF'
            printf '%s\n' "${uniq_tags[@]}"
            echo 'EOF'
            echo 'digests<<EOF'
            printf '%s\n' "${uniq_digests[@]}"
            echo 'EOF'
            echo 'arches<<EOF'
            printf '%s\n' "${arches_output[@]}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Step 3.4 - Summary (manifests)
        if: always()
        shell: bash
        run: |
          {
            echo "## üìö Multi-arch manifests"
            echo ""
            if [[ "${{ steps.create.outcome }}" == "success" ]]; then
              echo "‚úÖ All requested manifests were created."
            else
              echo "‚ùå Manifest creation encountered an error."
            fi
            echo ""
            echo "### üîñ Version"
            if [[ -n "${{ needs.build.outputs.version }}" ]]; then
              echo "- CHANGELOG version: **${{ needs.build.outputs.version }}**"
            else
              echo "- CHANGELOG version: *(unavailable)*"
            fi
            echo ""
            echo "### üè∑Ô∏è Final tags"
            TAGS_INPUT='${{ steps.create.outputs.tags }}'
            DIGESTS_INPUT='${{ steps.create.outputs.digests }}'
            declare -A DIGEST_LOOKUP=()
            if [[ -n "$DIGESTS_INPUT" ]]; then
              while IFS= read -r line; do
                [[ -n "${line// }" ]] || continue
                tag="${line%% *}"
                digest="${line#* }"
                DIGEST_LOOKUP["$tag"]="$digest"
              done <<< "$DIGESTS_INPUT"
            fi
            if [[ -n "$TAGS_INPUT" ]]; then
              while IFS= read -r line; do
                [[ -n "${line// }" ]] || continue
                image="${GHCR_NS}:${line}"
                echo "- \`$image\`"
                digest="${DIGEST_LOOKUP[$line]:-}"
                if [[ -n "$digest" ]]; then
                  if [[ "$digest" == sha256:* ]]; then
                    echo "  - sha256: \`${digest#sha256:}\`"
                  else
                    echo "  - digest: \`$digest\`"
                  fi
                else
                  echo "  - sha256: *(lookup failed)*"
                fi
              done <<< "$TAGS_INPUT"
            else
              echo "- (none)"
            fi
            echo ""
            echo "### üß© Architectures"
            ARCHES_OUTPUT='${{ steps.create.outputs.arches }}'
            if [[ -n "$ARCHES_OUTPUT" ]]; then
              for a in $ARCHES_OUTPUT; do
                echo "- ${a}"
              done
            else
              echo "- *(not available)*"
            fi
            echo ""
            echo "### üì¶ Registry"
            echo "- ghcr.io"
          } >> "$GITHUB_STEP_SUMMARY"
