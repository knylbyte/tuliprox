name: Docker Build & Push (develop)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

concurrency:
  group: docker-build-develop
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  actions: write

env:
  GHCR_NS: ghcr.io/${{ github.repository }}

jobs:
  prebuilds:
    name: Ensure tuliprox build tools exist
    runs-on: ubuntu-24.04
    outputs:
      need_build_tools: ${{ steps.check.outputs.need_build_tools }}
      archs: ${{ steps.arch.outputs.archs }}

    steps:
      - name: Step 1.1 - Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Step 1.2 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 1.3 - Set arch list
        id: arch
        shell: bash
        run: |
          set -euo pipefail
          echo "archs=linux-amd64 linux-arm64 linux-armv7" >> "$GITHUB_OUTPUT"

      - name: Step 1.4 - Check prebuild availability (all archs)
        id: check
        shell: bash
        env:
          BUILD_TOOLS_IMAGE: ${{ env.GHCR_NS }}/tuliprox-build-tools
        run: |
          set -euo pipefail
          need_build_tools=false
          for arch in ${{ steps.arch.outputs.archs }}; do
            if ! docker buildx imagetools inspect "${BUILD_TOOLS_IMAGE}:${arch}" >/dev/null 2>&1; then
              need_build_tools=true
            fi
          done
          echo "need_build_tools=$need_build_tools" >> "$GITHUB_OUTPUT"

      - name: Step 1.5 - Summary (tuliprox build tools check)
        if: always()
        shell: bash
        run: |
          {
            echo "## üõ†Ô∏è tuliprox-build-tools"
            if [[ "${{ steps.check.outputs.need_build_tools }}" == "true" ]]; then
              echo "‚ö†Ô∏è tuliprox-build-tools images missing for at least one architecture."
              echo "- A dedicated build job will run before the Docker build."
            else
              echo "‚úÖ All required prebuilds already present."
            fi
            echo ""
            echo "### üì¶ Tags checked"
            for a in ${{ steps.arch.outputs.archs }}; do
              echo "- \`${{ env.GHCR_NS }}/tuliprox-build-tools:${a}\`"
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Step 1.6 - Build tuliprox-build-tools if needed
        if: steps.check.outputs.need_build_tools == 'true'
        run: |
          gh workflow run docker-build-tuliprox-build-tools.yml --ref ${{ github.ref }} --repo ${{ github.repository }} --field trigger=gh-actions
          exit 1

  build:
    name: Build & Publish - Develop
    needs:
      - prebuilds
    outputs:
      version: ${{ steps.version.outputs.version }}
      archs: ${{ steps.build.outputs.archs }}
    env: 
      CACHE_CONTEXT: ${{ github.workspace }}/.ci-cache
      CACHE_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-cache-tmp
      BUILD_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-artifacts
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch_tag: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch_tag: linux-arm64
          # - platform: linux/arm/v7
          #   runner: ubuntu-24.04-arm
          #   arch_tag: linux-armv7
    runs-on: ${{ matrix.runner || 'ubuntu-24.04' }}

    steps:
      - name: Step 2.1 - Checkout
        uses: actions/checkout@v5

      - name: Step 2.2 - Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.3 - Set up Buildx
        uses: docker/setup-buildx-action@v3
        id: setup-buildx
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.4 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 2.5 - Read version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          ver="$(grep -Eom1 '^# [0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | awk '{print $2}')"
          if [[ -z "${ver:-}" ]]; then
            echo "Failed to parse version from CHANGELOG.md" >&2
            exit 1
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"
      
      - name: Step 2.6 - Create build directories
        run: |
          echo "Create build and cache directories..."
          mkdir -p ${{ env.CACHE_CONTEXT }}/${{ matrix.arch_tag }}
          mkdir -p ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          mkdir -p ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}

      - name: Step 2.7 - Download cache artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: cache-artifacts-${{ matrix.arch_tag }}
          path: ${{ env.CACHE_CONTEXT }}

      - name: Step 2.8 - Extract cache artifacts
        shell: bash
        working-directory: ${{ env.CACHE_CONTEXT }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          
          if [ -f ${{ matrix.arch_tag }}.tar.gz ]; then
            rm -rf ${{ matrix.arch_tag }} || true
            tar -xzvf ${{ matrix.arch_tag }}.tar.gz
            ls -al ${{ matrix.arch_tag }}/**
          else
            echo "Cache TAR file not found!"
            ls -al .
          fi;

          rm -rf *.tar.gz || true

      - name: Step 2.9 - Resolve Bake targets
        id: bake-targets
        shell: bash
        run: |
          {
            echo 'targets<<EOF'
            echo 'cache-export'
            echo 'scratch-final'
            echo 'alpine-final'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Step 2.10 - Build images with docker buildx bake
        id: build
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          ARCH_TAG: ${{ matrix.arch_tag }}
          PLATFORM: ${{ matrix.platform }}
          VERSION: ${{ steps.version.outputs.version }}
          DOCKER_TAR_DEST: ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          CACHE_CONTEXT: ${{ env.CACHE_CONTEXT }}/${{ matrix.arch_tag }}
          CACHE_DEST: ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          BUILDKIT_PROGRESS: plain
        run: |
          set -euo pipefail

          targets="${{ steps.bake-targets.outputs.targets }}"
          echo ""
          echo "Targets (raw):"
          printf '%s\n\n' "$targets"
          mapfile -t target_list <<<"$targets"
          
          echo "Running docker buildx bake with ${#target_list[@]} targets: ${target_list[*]}"
          docker buildx bake \
            --file docker/docker-bake.hcl \
            --allow=fs.write=${DOCKER_TAR_DEST} \
            --allow=fs.write=${CACHE_DEST} \
            --allow=fs.read=${CACHE_CONTEXT} \
            --load \
            --progress plain \
            "${target_list[@]}"

      - name: Step 2.10 - Compress cache artifacts for upload
        shell: bash
        working-directory: ${{ env.CACHE_CONTEXT }}
        run: |
          set -euo pipefail

          find ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }} -name '*.tar' -maxdepth 3 -exec mv {} ${{ matrix.arch_tag }}/ \;
          tar -czvf ${{ matrix.arch_tag}}.tar.gz ${{ matrix.arch_tag }}
          ls -al

      - name: Step 2.11 - Compress image artifacts for upload
        shell: bash
        working-directory: ${{ env.BUILD_ARTIFACTS_DEST }}
        run: |
          set -euo pipefail

          tar -czvf ${{ matrix.arch_tag}}.tar.gz ${{ matrix.arch_tag }}
          ls -al 

      - name: Step 2.12 - Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-images-${{ matrix.arch_tag }}
          path: ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}.tar.gz
          overwrite: true
          compression-level: 0
      
      - name: Step 2.13 - Upload cache artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cache-artifacts-${{ matrix.arch_tag }}
          path: ${{ env.CACHE_CONTEXT }}/${{ matrix.arch_tag }}.tar.gz
          overwrite: true
          compression-level: 0

      - name: Step 2.14 - Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## üß± Build Summary"
            echo ""
            echo "### üîñ Version"
            echo "- CHANGELOG version: **${{ steps.version.outputs.version }}**"
            echo ""
            echo "### üì¶ Exported artifacts"
            echo "- dev-slim-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}"
            echo "- dev-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}"
            echo ""
            echo "### üß∑ Cache"
            echo "- cache-from: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}\`"
            echo "- cache-from: \`type=registry,ref=${{ env.GHCR_NS }}:dev\`"
            echo "- cache-to: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }},mode=max\`"
            echo ""
            echo "### üß≠ Platforms"
            echo "- ${{ matrix.platform }}"
          } >> "$GITHUB_STEP_SUMMARY"
  
  manifests:
    name: Manifests
    needs:
      - prebuilds
      - build
    env:
      BUILD_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-artifacts
    runs-on: ubuntu-24.04

    steps:
      - name: Step 3.1 - Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Step 3.2 - GHCR Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 3.3 - Download image artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: dev-images-*
          path: ${{ env.BUILD_ARTIFACTS_DEST }}
          merge-multiple: true
      
      - name: Step 3.4 - Extract build artefacts
        shell: bash
        working-directory: ${{ env.BUILD_ARTIFACTS_DEST }}
        run: |
          set -euo pipefail
          shopt -s nullglob

          for img in *.tar.gz; do
            tar -xzvf $img
          done;

          rm -rf *.tar.gz || true
          ls -al ./**

      - name: Step 3.4 - Load images
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          for archdir in ${{ env.BUILD_ARTIFACTS_DEST }}/*; do
            [ -d "$archdir" ] || continue

            arch_tag="$(basename "$archdir")"
            echo "::group::Loading images for ${arch_tag}"

            for enddir in "$archdir"/alpine-final "$archdir"/scratch-final; do
              [ -d "$enddir" ] || continue

              for img in "$enddir"/*.tar; do
                [ -f "$img" ] || continue
                docker image load -i "$img"
              done

            done
            echo "::endgroup::"

          done

          docker image ls

      - name: Step 3.5 - Export arch_tags
        id: export_arch_tags
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t arr < <(find .ci-artifacts -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort)
          json="$(printf '%s\n' "${arr[@]}" | jq -R . | jq -s .)"
          echo "arch_tags_json=${json}" >> "$GITHUB_OUTPUT"


      - name: Step 3.4 - Create and publish manifests
        id: create
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          VERSION: ${{ needs.build.outputs.version }}
        run: echo "tba"

      - name: Step 3.4 - Summary (manifests)
        if: always()
        shell: bash
        run: |
          {
            echo "## üìö Multi-arch manifests"
            echo ""
            if [[ "${{ steps.create.outcome }}" == "success" ]]; then
              echo "‚úÖ All requested manifests were created."
            else
              echo "‚ùå Manifest creation encountered an error."
            fi
            echo ""
            echo "### üîñ Version"
            if [[ -n "${{ needs.build.outputs.version }}" ]]; then
              echo "- CHANGELOG version: **${{ needs.build.outputs.version }}**"
            else
              echo "- CHANGELOG version: *(unavailable)*"
            fi
            echo ""
            echo "### üè∑Ô∏è Final tags"
            TAGS_INPUT='${{ steps.create.outputs.tags }}'
            DIGESTS_INPUT='${{ steps.create.outputs.digests }}'
            declare -A DIGEST_LOOKUP=()
            if [[ -n "$DIGESTS_INPUT" ]]; then
              while IFS= read -r line; do
                [[ -n "${line// }" ]] || continue
                tag="${line%% *}"
                digest="${line#* }"
                DIGEST_LOOKUP["$tag"]="$digest"
              done <<< "$DIGESTS_INPUT"
            fi
            if [[ -n "$TAGS_INPUT" ]]; then
              while IFS= read -r line; do
                [[ -n "${line// }" ]] || continue
                image="${GHCR_NS}:${line}"
                echo "- \`$image\`"
                digest="${DIGEST_LOOKUP[$line]:-}"
                if [[ -n "$digest" ]]; then
                  if [[ "$digest" == sha256:* ]]; then
                    echo "  - sha256: \`${digest#sha256:}\`"
                  else
                    echo "  - digest: \`$digest\`"
                  fi
                else
                  echo "  - sha256: *(lookup failed)*"
                fi
              done <<< "$TAGS_INPUT"
            else
              echo "- (none)"
            fi
            echo ""
            echo "### üß© Architectures"
            ARCHES_OUTPUT='${{ steps.create.outputs.arches }}'
            if [[ -n "$ARCHES_OUTPUT" ]]; then
              for a in $ARCHES_OUTPUT; do
                echo "- ${a}"
              done
            else
              echo "- *(not available)*"
            fi
            echo ""
            echo "### üì¶ Registry"
            echo "- ghcr.io"
          } >> "$GITHUB_STEP_SUMMARY"
