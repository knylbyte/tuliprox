name: Docker Build & Push (develop)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

concurrency:
  group: docker-build-develop
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  actions: write

env:
  GHCR_NS: ghcr.io/${{ github.repository }}
  DOCKERFILE: docker/ci.Dockerfile

jobs:
  prebuilds:
    name: Ensure tuliprox build tools exist
    runs-on: ubuntu-24.04
    outputs:
      need_build_tools: ${{ steps.check.outputs.need_build_tools }}
      archs: ${{ steps.arch.outputs.archs }}

    steps:
      - name: Step 1.1 - Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Step 1.2 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 1.3 - Set arch list
        id: arch
        shell: bash
        run: |
          set -euo pipefail
          echo "archs=linux-amd64 linux-arm64 linux-armv7" >> "$GITHUB_OUTPUT"

      - name: Step 1.4 - Check prebuild availability (all archs)
        id: check
        shell: bash
        env:
          BUILD_TOOLS_IMAGE: ${{ env.GHCR_NS }}/tuliprox-build-tools
        run: |
          set -euo pipefail
          need_build_tools=false
          for arch in ${{ steps.arch.outputs.archs }}; do
            if ! docker buildx imagetools inspect "${BUILD_TOOLS_IMAGE}:${arch}" >/dev/null 2>&1; then
              need_build_tools=true
            fi
          done
          echo "need_build_tools=$need_build_tools" >> "$GITHUB_OUTPUT"

      - name: Step 1.5 - Summary (tuliprox build tools check)
        if: always()
        shell: bash
        run: |
          {
            echo "## üõ†Ô∏è tuliprox-build-tools"
            if [[ "${{ steps.check.outputs.need_build_tools }}" == "true" ]]; then
              echo "‚ö†Ô∏è tuliprox-build-tools images missing for at least one architecture."
              echo "- A dedicated build job will run before the Docker build."
            else
              echo "‚úÖ All required prebuilds already present."
            fi
            echo ""
            echo "### üì¶ Tags checked"
            for a in ${{ steps.arch.outputs.archs }}; do
              echo "- \`${{ env.GHCR_NS }}/tuliprox-build-tools:${a}\`"
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Step 1.6 - Build tuliprox-build-tools if needed
        if: steps.check.outputs.need_build_tools == 'true'
        run: |
          gh workflow run docker-build-tuliprox-build-tools.yml --ref ${{ github.ref }} --repo ${{ github.repository }} --field trigger=gh-actions
          exit 1

  build:
    name: Build & Publish - Develop
    needs:
      - prebuilds
    outputs:
      version: ${{ steps.version.outputs.version }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch_tag: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch_tag: linux-arm64
          # - platform: linux/arm/v7
          #   runner: ubuntu-24.04-arm
          #   arch_tag: linux-armv7
    runs-on: ${{ matrix.runner || 'ubuntu-24.04' }}

    steps:
      - name: Step 2.1 - Checkout
        uses: actions/checkout@v5

      - name: Step 2.2 - Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.3 - Set up Buildx
        uses: docker/setup-buildx-action@v3
        id: setup-buildx
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.4 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 2.5 - Read version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          ver="$(grep -Eom1 '^# [0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | awk '{print $2}')"
          if [[ -z "${ver:-}" ]]; then
            echo "Failed to parse version from CHANGELOG.md" >&2
            exit 1
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Step 2.6 - Prepare cache context directory
        run: mkdir -p ${{ github.workspace }}/.ci-cache/${{ matrix.arch_tag }} /tmp/.ci-cache/${{ matrix.arch_tag }}

      - name: Step 2.7 - Prepare image artifact directory
        run: mkdir -p ${{ github.workspace }}/.ci-artifacts/${{ matrix.arch_tag }}

      - name: Step 2.8 - Load cache directories for Docker build
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            .ci-cache/${{ matrix.arch_tag }}
          key: ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-${{ github.sha256 }}
          restore-keys: |
            ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-

      - name: Step 2.9 - Resolve Bake targets
        id: bake-targets
        shell: bash
        run: |
          {
            echo 'targets<<EOF'
            echo 'cache-export'
            echo 'scratch-final'
            echo 'alpine-final'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Step 2.10 - Build images with docker buildx bake (debug)
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          ARCH_TAG: ${{ matrix.arch_tag }}
          PLATFORM: ${{ matrix.platform }}
          VERSION: ${{ steps.version.outputs.version }}
          DOCKER_IMAGE_DEST: ${{ github.workspace }}/.ci-artifacts/${{ matrix.arch_tag }}
          CACHE_CONTEXT: ${{ github.workspace }}/.ci-cache/${{ matrix.arch_tag }}
          CACHE_DEST: /tmp/.ci-cache/${{ matrix.arch_tag }}
          BUILDKIT_PROGRESS: plain
        run: |
          set -euo pipefail
          echo "Cache contents before build:"
          ls -al ${CACHE_CONTEXT}
          
          targets="${{ steps.bake-targets.outputs.targets }}"
          echo "Targets (raw):"
          printf '  %s\n' "$targets"
          mapfile -t target_list <<<"$targets"
          
          echo "Running docker buildx bake with ${#target_list[@]} targets: ${target_list[*]}"
          docker buildx bake \
            --file docker/docker-bake.hcl \
            --allow=fs.write=${DOCKER_IMAGE_DEST} \
            --allow=fs.write=${CACHE_DEST} \
            --allow=fs.read=${CACHE_CONTEXT} \
            --load \
            --progress plain \
            "${target_list[@]}"

      - name: Step 2.11 - Move cache TARs
        shell: bash
        run: |
          set -euo pipefail
          find /tmp/.ci-cache/${{ matrix.arch_tag }} -name '*.tar' -maxdepth 3 -exec mv {} .ci-cache/${{ matrix.arch_tag }}/ \;
          ls -al ${{ github.workspace }}/.ci-cache/${{ matrix.arch_tag }}
          rm -rf /tmp/.ci-cache/${{ matrix.arch_tag }}
      
      - name: print outputs
        run: ls -al .ci-artifacts/${{ matrix.arch_tag }}

      - name: Step 2.13 - Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dev-images-${{ matrix.arch_tag }}
          path: .ci-artifacts/${{ matrix.arch_tag }}
          if-no-files-found: error

      - name: Step 2.14 - Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## üß± Build Summary"
            echo ""
            echo "### üîñ Version"
            echo "- CHANGELOG version: **${{ steps.version.outputs.version }}**"
            echo ""
            echo "### üì¶ Exported artifacts"
            echo "- dev-slim-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }} (DOCKER image)"
            echo "- dev-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }} (DOCKER image)"
            echo ""
            echo "### üß∑ Cache"
            echo "- cache-from: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}\`"
            echo "- cache-from: \`type=registry,ref=${{ env.GHCR_NS }}:dev\`"
            echo "- cache-to: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }},mode=max\`"
            echo ""
            echo "### üß≠ Platforms"
            echo "- ${{ matrix.platform }}"
          } >> "$GITHUB_STEP_SUMMARY"
  
  manifests:
    name: Manifests
    needs:
      - prebuilds
      - build
    runs-on: ubuntu-24.04

    steps:
      - name: Step 3.1 - Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Step 3.2 - GHCR Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 3.3 - Download image artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: dev-images-*
          path: .ci-artifacts
          merge-multiple: false

      - name: Step 3.4 - Create and publish manifests from ci-artifacts
        id: create
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.build.outputs.version }}"

          if [[ -z "${VERSION:-}" ]]; then
            echo "Unable to determine version for manifest creation." >&2
            exit 1
          fi

          ARCHES_INPUT='${{ needs.prebuilds.outputs.archs }}'



          set -euo pipefail
          shopt -s nullglob

          # --- helpers ---
          # Map <arch> dir name to manifest annotate args
          ann_args() {
            case "$1" in
              amd64) echo "--os linux --arch amd64" ;;
              arm64) echo "--os linux --arch arm64 --variant v8" ;;
              armv7|armhf) echo "--os linux --arch arm --variant v7" ;;
              *) echo "--os linux --arch $1" ;;
            esac
          }

          # Build & push a manifest from parallel arrays (refs[] with plats[])
          make_manifest() {
            local target="$1"; shift
            local -n _refs="$1"; shift
            local -n _plats="$1"; shift

            ((${# _refs[@]})) || { echo "Skip $target (no entries)"; return 0; }

            echo "Create manifest: $target"
            docker manifest create "$target" "${_refs[@]}"

            # Annotate each entry with platform
            for i in "${!_refs[@]}"; do
              local ref="${_refs[$i]}"
              local plat="${_plats[$i]}"
              # shellcheck disable=SC2046
              docker manifest annotate "$target" "$ref" $(ann_args "$plat")
            done

            echo "Push manifest: $target"
            docker manifest push --purge "$target"
          }

          # --- collect scratch-final (dev-slim) ---
          declare -a SLIM_REFS=()
          declare -a SLIM_PLATS=()

          for tarf in .ci-artifacts/*/scratch-final/*.docker; do
            arch="$(basename "$(dirname "$(dirname "$tarf")")")"
            echo "Load scratch-final ${arch} -> $tarf"
            out="$(docker load --input "$tarf")"
            ref="$(echo "$out" | awk -F': ' '/Loaded image:/ {print $3; exit}')"
            [[ -n "${ref:-}" ]] || { echo "No tag found in $tarf"; exit 1; }
            SLIM_REFS+=( "$ref" )
            SLIM_PLATS+=( "$arch" )
          done

          # --- collect alpine-final (dev) ---
          declare -a NORM_REFS=()
          declare -a NORM_PLATS=()

          for tarf in .ci-artifacts/*/alpine-final/*.docker; do
            arch="$(basename "$(dirname "$(dirname "$tarf")")")"
            echo "Load alpine-final ${arch} -> $tarf"
            out="$(docker load --input "$tarf")"
            ref="$(echo "$out" | awk -F': ' '/Loaded image:/ {print $3; exit}')"
            [[ -n "${ref:-}" ]] || { echo "No tag found in $tarf"; exit 1; }
            NORM_REFS+=( "$ref" )
            NORM_PLATS+=( "$arch" )
          done

          # --- push manifests (moving + versioned) ---------------------------------
          make_manifest "${NS}:dev-slim"            SLIM_REFS SLIM_PLATS
          make_manifest "${NS}:dev-slim-${VERSION}" SLIM_REFS SLIM_PLATS

          make_manifest "${NS}:dev"            NORM_REFS NORM_PLATS
          make_manifest "${NS}:dev-${VERSION}" NORM_REFS NORM_PLATS

      - name: Step 3.4 - Summary (manifests)
        if: always()
        shell: bash
        run: |
          {
            echo "## üìö Multi-arch manifests"
            echo ""
            if [[ "${{ steps.create.outcome }}" == "success" ]]; then
              echo "‚úÖ All requested manifests were created."
            else
              echo "‚ùå Manifest creation encountered an error."
            fi
            echo ""
            echo "### üîñ Version"
            if [[ -n "${{ needs.build.outputs.version }}" ]]; then
              echo "- CHANGELOG version: **${{ needs.build.outputs.version }}**"
            else
              echo "- CHANGELOG version: *(unavailable)*"
            fi
            echo ""
            echo "### üè∑Ô∏è Final tags"
            TAGS_INPUT='${{ steps.create.outputs.tags }}'
            DIGESTS_INPUT='${{ steps.create.outputs.digests }}'
            declare -A DIGEST_LOOKUP=()
            if [[ -n "$DIGESTS_INPUT" ]]; then
              while IFS= read -r line; do
                [[ -n "${line// }" ]] || continue
                tag="${line%% *}"
                digest="${line#* }"
                DIGEST_LOOKUP["$tag"]="$digest"
              done <<< "$DIGESTS_INPUT"
            fi
            if [[ -n "$TAGS_INPUT" ]]; then
              while IFS= read -r line; do
                [[ -n "${line// }" ]] || continue
                image="${GHCR_NS}:${line}"
                echo "- \`$image\`"
                digest="${DIGEST_LOOKUP[$line]:-}"
                if [[ -n "$digest" ]]; then
                  if [[ "$digest" == sha256:* ]]; then
                    echo "  - sha256: \`${digest#sha256:}\`"
                  else
                    echo "  - digest: \`$digest\`"
                  fi
                else
                  echo "  - sha256: *(lookup failed)*"
                fi
              done <<< "$TAGS_INPUT"
            else
              echo "- (none)"
            fi
            echo ""
            echo "### üß© Architectures"
            ARCHES_OUTPUT='${{ steps.create.outputs.arches }}'
            if [[ -n "$ARCHES_OUTPUT" ]]; then
              for a in $ARCHES_OUTPUT; do
                echo "- ${a}"
              done
            else
              echo "- *(not available)*"
            fi
            echo ""
            echo "### üì¶ Registry"
            echo "- ghcr.io"
          } >> "$GITHUB_STEP_SUMMARY"
