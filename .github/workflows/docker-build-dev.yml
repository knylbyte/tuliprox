name: Docker Build & Push (develop)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

concurrency:
  group: docker-build-develop
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  actions: write

env:
  GHCR_NS: ghcr.io/${{ github.repository }}

jobs:
  prebuilds:
    name: Ensure tuliprox build tools exist
    runs-on: ubuntu-24.04
    outputs:
      need_build_tools: ${{ steps.check.outputs.need_build_tools }}
      archs: ${{ steps.arch.outputs.archs }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set arch list
        id: arch
        shell: bash
        run: |
          set -euo pipefail
          echo "archs=linux-amd64 linux-arm64 linux-armv7" >> "$GITHUB_OUTPUT"

      - name: Check prebuild availability (all archs)
        id: check
        shell: bash
        env:
          BUILD_TOOLS_IMAGE: ${{ env.GHCR_NS }}/tuliprox-build-tools
        run: |
          set -euo pipefail
          need_build_tools=false
          for arch in ${{ steps.arch.outputs.archs }}; do
            if ! docker buildx imagetools inspect "${BUILD_TOOLS_IMAGE}:${arch}" >/dev/null 2>&1; then
              need_build_tools=true
            fi
          done
          echo "need_build_tools=$need_build_tools" >> "$GITHUB_OUTPUT"

      - name: Summary (tuliprox build tools check)
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ› ï¸ tuliprox-build-tools"
            if [[ "${{ steps.check.outputs.need_build_tools }}" == "true" ]]; then
              echo "âš ï¸ tuliprox-build-tools images missing for at least one architecture."
              echo "- A dedicated build job will run before the Docker build."
            else
              echo "âœ… All required prebuilds already present."
            fi
            echo ""
            echo "### ðŸ“¦ Tags checked"
            for a in ${{ steps.arch.outputs.archs }}; do
              echo "- \`${{ env.GHCR_NS }}/tuliprox-build-tools:${a}\`"
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Build tuliprox-build-tools if needed
        if: steps.check.outputs.need_build_tools == 'true'
        run: |
          gh workflow run docker-build-tuliprox-build-tools.yml --ref ${{ github.ref }} --repo ${{ github.repository }} --field trigger=gh-actions
          exit 1

  build:
    name: Build & Publish - Develop
    needs:
      - prebuilds
    outputs:
      version: ${{ steps.version.outputs.version }}
      archs: ${{ steps.build.outputs.archs }}
    env: 
      CACHE_CONTEXT: ${{ github.workspace }}/.ci-cache
      CACHE_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-cache-tmp
      BUILD_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-artifacts
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch_tag: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch_tag: linux-arm64
          # - platform: linux/arm/v7
          #   runner: ubuntu-24.04-arm
          #   arch_tag: linux-armv7
    runs-on: ${{ matrix.runner || 'ubuntu-24.04' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3
        id: setup-buildx
        with:
          platforms: ${{ matrix.platform }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Read version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          ver="$(grep -Eom1 '^# [0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | awk '{print $2}')"
          if [[ -z "${ver:-}" ]]; then
            echo "Failed to parse version from CHANGELOG.md" >&2
            exit 1
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"
      
      - name: Create build directories
        run: |
          echo "Create build and cache directories..."
          mkdir -p ${{ env.CACHE_CONTEXT }}/${{ matrix.arch_tag }}
          mkdir -p ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          mkdir -p ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}

      - name: Up-/Download cache artifacts
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ${{ env.CACHE_CONTEXT }}
          key: ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-

      - name: Extract cache artifacts
        shell: bash
        working-directory: ${{ env.CACHE_CONTEXT }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          
          if [ -f ${{ matrix.arch_tag }}.tar ]; then
            rm -rf ${{ matrix.arch_tag }} || true
            tar -xvf ${{ matrix.arch_tag }}.tar
          else
            echo "Cache TAR file not found!"
            ls -al .
          fi;

          rm -rf *.tar || true

      - name: Step 2.10 - Resolve Bake targets
        id: bake-targets
        shell: bash
        run: |
          {
            echo 'targets<<EOF'
            echo 'cache-export'
            echo 'scratch-final'
            echo 'alpine-final'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Step 2.11 - Build images with docker buildx bake
        id: build
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          ARCH_TAG: ${{ matrix.arch_tag }}
          PLATFORM: ${{ matrix.platform }}
          VERSION: ${{ steps.version.outputs.version }}
          DOCKER_TAR_DEST: ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          CACHE_CONTEXT: ${{ env.CACHE_CONTEXT }}/${{ matrix.arch_tag }}
          CACHE_DEST: ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          BUILDKIT_PROGRESS: plain
        run: |
          set -euo pipefail

          targets="${{ steps.bake-targets.outputs.targets }}"
          echo ""
          echo "Targets (raw):"
          printf '%s\n\n' "$targets"
          mapfile -t target_list <<<"$targets"
          
          echo "Running docker buildx bake with ${#target_list[@]} targets: ${target_list[*]}"
          docker buildx bake \
            --file docker/docker-bake.hcl \
            --allow=fs.write=${DOCKER_TAR_DEST} \
            --allow=fs.write=${CACHE_DEST} \
            --allow=fs.read=${CACHE_CONTEXT} \
            --metadata-file ${{ runner.temp }}/metadata.json \
            --load \
            --progress plain \
            "${target_list[@]}"

          cat ${{ runner.temp }}/metadata.json

      - name: Step 2.12 - Archive cache artifacts for upload
        shell: bash
        working-directory: ${{ env.CACHE_CONTEXT }}
        run: |
          set -euo pipefail

          find ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }} -name '*.tar' -maxdepth 3 -exec mv {} ${{ matrix.arch_tag }}/ \;
          tar -cvf ${{ matrix.arch_tag}}.tar ${{ matrix.arch_tag }}
          rm -rf ${{ matrix.arch_tag }}
          ls -al

      - name: Export digests
        shell: bash
        run: |
          set -euo pipefail

          META="${{ runner.temp }}/metadata.json"
          mkdir -p "${{ runner.temp }}/digests"

          jq -er '
            to_entries[]
            | select(.value["containerimage.digest"]?)
            | "\(.key) \(.value["containerimage.digest"])"
          ' "$META" | while read -r target digest; do
            mkdir -p "${{ runner.temp }}/digests/${target}"
            touch "${{ runner.temp }}/digests/${target}/${digest#sha256:}"
          done

          ls -al ${{ runner.temp }}/digests/*/*

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch_tag }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

      # - name: Step 2.11 - Archive image artifacts for upload
      #   shell: bash
      #   working-directory: ${{ env.BUILD_ARTIFACTS_DEST }}
      #   run: |
      #     set -euo pipefail

      #     tar -cvf ${{ matrix.arch_tag}}.tar ${{ matrix.arch_tag }}
      #     ls -al 

      # - name: Step 2.12 - Upload image artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dev-images-${{ matrix.arch_tag }}
      #     path: ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}.tar
          # overwrite: true

      - name: Step 2.13 - Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ§± Build Summary"
            echo ""
            echo "### ðŸ”– Version"
            echo "- CHANGELOG version: **${{ steps.version.outputs.version }}**"
            echo ""
            echo "### ðŸ“¦ Exported artifacts"
            echo "- scratch-final:  \`dev-slim-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}\`"
            echo "- alpine-final:   \`dev-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}\`"
            echo ""
            echo "### ðŸ§· Cache"
            echo "- cache-from: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}\`"
            echo "- cache-from: \`type=registry,ref=${{ env.GHCR_NS }}:dev\`"
            echo "- cache-to:   \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }},mode=max\`"
            echo ""
            echo "### ðŸ§­ Platforms"
            echo "- ${{ matrix.platform }}"
          } >> "$GITHUB_STEP_SUMMARY"

  ### TEST: CI build with push by digest

  manifests:
    name: Manifests
    needs:
      - prebuilds
      - build
    runs-on: ubuntu-24.04

    steps:
      - name: Set up Docker
        uses: docker/setup-docker-action@v4

      - name: GHCR Login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - name: Create manifest and push (scratch-final)
        working-directory: ${{ runner.temp }}/digests/scratch-final
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.build.outputs.version }}"

          docker buildx imagetools create \
            -t "${{ env.GHCR_NS }}:dev-slim" \
            -t "${{ env.GHCR_NS }}:dev-slim-${VERSION}" \
            $(printf '${{ env.GHCR_NS }}@sha256:%s ' *)

          echo "Inspect: ${{ env.GHCR_NS }}:dev-slim"
          docker buildx imagetools inspect "${{ env.GHCR_NS }}:dev-slim"

          echo "Inspect: ${{ env.GHCR_NS }}:dev-slim-${VERSION}"
          docker buildx imagetools inspect "${{ env.GHCR_NS }}:dev-slim-${VERSION}"

      - name: Create manifest and push (alpine-final)
        working-directory: ${{ runner.temp }}/digests/alpine-final
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.build.outputs.version }}"

          docker buildx imagetools create \
            -t "${{ env.GHCR_NS }}:dev" \
            -t "${{ env.GHCR_NS }}:dev-${VERSION}" \
            $(printf '${{ env.GHCR_NS }}@sha256:%s ' *)

          echo "Inspect: ${{ env.GHCR_NS }}:dev"
          docker buildx imagetools inspect "${{ env.GHCR_NS }}:dev"

          echo "Inspect: ${{ env.GHCR_NS }}:dev-${VERSION}"
          docker buildx imagetools inspect "${{ env.GHCR_NS }}:dev-${VERSION}"

      - name: Create manifest and push (cache-export)
        working-directory: ${{ runner.temp }}/digests/cache-export
        shell: bash
        run: |
          set -euo pipefail

          docker buildx imagetools create \
            -t "${{ env.GHCR_NS }}:cache" \
            $(printf '${{ env.GHCR_NS }}@sha256:%s ' *)

          echo "Inspect: ${{ env.GHCR_NS }}:cache"
          docker buildx imagetools inspect "${{ env.GHCR_NS }}:cache"

      - name: Summary (manifests)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          STATUS="${{ job.status }}"
          VERSION="${{ needs.build.outputs.version }}"
          ROOT="${{ runner.temp }}/digests"
          NS="${{ env.GHCR_NS }}"

          count_digests() {
            local dir="$1"
            if [[ -d "$dir" ]]; then
              # count only regular files
              find "$dir" -maxdepth 1 -type f | wc -l | tr -d ' '
            else
              echo "0"
            fi
          }

          SCRATCH_CNT="$(count_digests "${ROOT}/scratch-final")"
          ALPINE_CNT="$(count_digests "${ROOT}/alpine-final")"
          CACHE_CNT="$(count_digests "${ROOT}/cache-export")"

          {
            echo "## ðŸ“š Multi-arch manifests"
            echo ""
            case "$STATUS" in
              success)   echo "âœ… All requested manifests were created." ;;
              cancelled) echo "âš ï¸ Manifest creation was cancelled." ;;
              *)         echo "âŒ Manifest creation encountered an error." ;;
            esac
            echo ""

            echo "### ðŸ”– Version"
            if [[ -n "$VERSION" ]]; then
              echo "- CHANGELOG version: **$VERSION**"
            else
              echo "- CHANGELOG version: *(unavailable)*"
            fi
            echo ""

            echo "### ðŸ·ï¸ Final tags"
            echo ""
            echo "- **scratch-final** (${SCRATCH_CNT} digests)"
            echo "  - \`${NS}:dev-slim\`"
            if [[ -n "$VERSION" ]]; then
              echo "  - \`${NS}:dev-slim-${VERSION}\`"
            fi
            echo ""
            echo "- **alpine-final** (${ALPINE_CNT} digests)"
            echo "  - \`${NS}:dev\`"
            if [[ -n "$VERSION" ]]; then
              echo "  - \`${NS}:dev-${VERSION}\`"
            fi
            echo ""
            echo "- **cache-export** (${CACHE_CNT} digests)"
            echo "  - \`${NS}:cache\`"
            echo ""

            echo "### ðŸ“¦ Registry"
            echo "- ghcr.io"
          } >> "$GITHUB_STEP_SUMMARY"

