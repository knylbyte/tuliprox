name: Docker Build & Push (develop)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

concurrency:
  group: docker-build-develop
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  actions: write

env:
  GHCR_NS: ghcr.io/${{ github.repository }}

jobs:
  prebuilds:
    name: Ensure tuliprox build tools exist
    runs-on: ubuntu-24.04
    outputs:
      need_build_tools: ${{ steps.check.outputs.need_build_tools }}
      archs: ${{ steps.arch.outputs.archs }}

    steps:
      - name: Step 1.1 - Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Step 1.2 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 1.3 - Set arch list
        id: arch
        shell: bash
        run: |
          set -euo pipefail
          echo "archs=linux-amd64 linux-arm64 linux-armv7" >> "$GITHUB_OUTPUT"

      - name: Step 1.4 - Check prebuild availability (all archs)
        id: check
        shell: bash
        env:
          BUILD_TOOLS_IMAGE: ${{ env.GHCR_NS }}/tuliprox-build-tools
        run: |
          set -euo pipefail
          need_build_tools=false
          for arch in ${{ steps.arch.outputs.archs }}; do
            if ! docker buildx imagetools inspect "${BUILD_TOOLS_IMAGE}:${arch}" >/dev/null 2>&1; then
              need_build_tools=true
            fi
          done
          echo "need_build_tools=$need_build_tools" >> "$GITHUB_OUTPUT"

      - name: Step 1.5 - Summary (tuliprox build tools check)
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ› ï¸ tuliprox-build-tools"
            if [[ "${{ steps.check.outputs.need_build_tools }}" == "true" ]]; then
              echo "âš ï¸ tuliprox-build-tools images missing for at least one architecture."
              echo "- A dedicated build job will run before the Docker build."
            else
              echo "âœ… All required prebuilds already present."
            fi
            echo ""
            echo "### ðŸ“¦ Tags checked"
            for a in ${{ steps.arch.outputs.archs }}; do
              echo "- \`${{ env.GHCR_NS }}/tuliprox-build-tools:${a}\`"
            done
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Step 1.6 - Build tuliprox-build-tools if needed
        if: steps.check.outputs.need_build_tools == 'true'
        run: |
          gh workflow run docker-build-tuliprox-build-tools.yml --ref ${{ github.ref }} --repo ${{ github.repository }} --field trigger=gh-actions
          exit 1

  build:
    name: Build & Publish - Develop
    needs:
      - prebuilds
    outputs:
      version: ${{ steps.version.outputs.version }}
      archs: ${{ steps.build.outputs.archs }}
    env: 
      CACHE_CONTEXT: ${{ github.workspace }}/.ci-cache
      CACHE_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-cache-tmp
      BUILD_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-artifacts
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch_tag: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch_tag: linux-arm64
          # - platform: linux/arm/v7
          #   runner: ubuntu-24.04-arm
          #   arch_tag: linux-armv7
    runs-on: ${{ matrix.runner || 'ubuntu-24.04' }}

    steps:
      - name: Step 2.1 - Checkout
        uses: actions/checkout@v5

      - name: Step 2.2 - Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.3 - Free up disk space
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          echo "Disk usage before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /opt/ghc || true
          docker system prune -af || true
          echo "Disk usage after cleanup:"
          df -h

      - name: Step 2.4 - Set up Buildx
        uses: docker/setup-buildx-action@v3
        id: setup-buildx
        with:
          platforms: ${{ matrix.platform }}

      - name: Step 2.5 - Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Step 2.6 - Read version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          ver="$(grep -Eom1 '^# [0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | awk '{print $2}')"
          if [[ -z "${ver:-}" ]]; then
            echo "Failed to parse version from CHANGELOG.md" >&2
            exit 1
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"
      
      - name: Step 2.7 - Create build directories
        run: |
          echo "Create build and cache directories..."
          mkdir -p ${{ env.CACHE_CONTEXT }}/${{ matrix.arch_tag }}
          mkdir -p ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          mkdir -p ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}

      - name: Step 2.8 - Up-/Download cache artifacts
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ${{ env.CACHE_CONTEXT }}
          key: ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ci-cache-${{ matrix.arch_tag }}-

      - name: Step 2.9 - Extract cache artifacts
        shell: bash
        working-directory: ${{ env.CACHE_CONTEXT }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          
          if [ -f ${{ matrix.arch_tag }}.tar ]; then
            rm -rf ${{ matrix.arch_tag }} || true
            tar -xvf ${{ matrix.arch_tag }}.tar
          else
            echo "Cache TAR file not found!"
            ls -al .
          fi;

          rm -rf *.tar || true

      - name: Step 2.10 - Resolve Bake targets
        id: bake-targets
        shell: bash
        run: |
          {
            echo 'targets<<EOF'
            echo 'cache-export'
            echo 'scratch-final'
            echo 'alpine-final'
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Step 2.11 - Build images with docker buildx bake
        id: build
        shell: bash
        env:
          GHCR_NS: ${{ env.GHCR_NS }}
          ARCH_TAG: ${{ matrix.arch_tag }}
          PLATFORM: ${{ matrix.platform }}
          VERSION: ${{ steps.version.outputs.version }}
          DOCKER_TAR_DEST: ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          CACHE_CONTEXT: ${{ env.CACHE_CONTEXT }}/${{ matrix.arch_tag }}
          CACHE_DEST: ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}
          BUILDKIT_PROGRESS: plain
        run: |
          set -euo pipefail

          targets="${{ steps.bake-targets.outputs.targets }}"
          echo ""
          echo "Targets (raw):"
          printf '%s\n\n' "$targets"
          mapfile -t target_list <<<"$targets"
          
          echo "Running docker buildx bake with ${#target_list[@]} targets: ${target_list[*]}"
          docker buildx bake \
            --file docker/docker-bake.hcl \
            --allow=fs.write=${DOCKER_TAR_DEST} \
            --allow=fs.write=${CACHE_DEST} \
            --allow=fs.read=${CACHE_CONTEXT} \
            --metadata-file metadata-${{ matrix.arch_tag }}.json \
            --load \
            --progress plain \
            "${target_list[@]}"

          cat metadata-${{ matrix.arch_tag }}.json

      - name: Step 2.12 - Archive cache artifacts for upload
        shell: bash
        working-directory: ${{ env.CACHE_CONTEXT }}
        run: |
          set -euo pipefail

          find ${{ env.CACHE_ARTIFACTS_DEST }}/${{ matrix.arch_tag }} -name '*.tar' -maxdepth 3 -exec mv {} ${{ matrix.arch_tag }}/ \;
          tar -cvf ${{ matrix.arch_tag}}.tar ${{ matrix.arch_tag }}
          rm -rf ${{ matrix.arch_tag }}
          ls -al

      # - name: Step 2.11 - Archive image artifacts for upload
      #   shell: bash
      #   working-directory: ${{ env.BUILD_ARTIFACTS_DEST }}
      #   run: |
      #     set -euo pipefail

      #     tar -cvf ${{ matrix.arch_tag}}.tar ${{ matrix.arch_tag }}
      #     ls -al 

      # - name: Step 2.12 - Upload image artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dev-images-${{ matrix.arch_tag }}
      #     path: ${{ env.BUILD_ARTIFACTS_DEST }}/${{ matrix.arch_tag }}.tar
          # overwrite: true

      - name: Step 2.13 - Summary
        if: always()
        shell: bash
        run: |
          {
            echo "## ðŸ§± Build Summary"
            echo ""
            echo "### ðŸ”– Version"
            echo "- CHANGELOG version: **${{ steps.version.outputs.version }}**"
            echo ""
            echo "### ðŸ“¦ Exported artifacts"
            echo "- scratch-final:  \`dev-slim-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}\`"
            echo "- alpine-final:   \`dev-${{ steps.version.outputs.version }}-${{ matrix.arch_tag }}\`"
            echo ""
            echo "### ðŸ§· Cache"
            echo "- cache-from: \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }}\`"
            echo "- cache-from: \`type=registry,ref=${{ env.GHCR_NS }}:dev\`"
            echo "- cache-to:   \`type=gha,scope=dev-cache-export-${{ matrix.arch_tag }},mode=max\`"
            echo ""
            echo "### ðŸ§­ Platforms"
            echo "- ${{ matrix.platform }}"
          } >> "$GITHUB_STEP_SUMMARY"

  ### TEST: CI build with push by digest

  # manifests:
  #   name: Manifests
  #   needs:
  #     - prebuilds
  #     - build
  #   env:
  #     BUILD_ARTIFACTS_DEST: ${{ github.workspace }}/.ci-artifacts
  #   runs-on: ubuntu-24.04

  #   steps:
  #     - name: Step 3.1 - Set up Docker
  #       uses: docker/setup-docker-action@v4

  #     - name: Step 3.2 - GHCR Login
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Step 3.3 - Download image artifacts
  #       uses: actions/download-artifact@v5
  #       with:
  #         pattern: dev-images-*
  #         path: ${{ env.BUILD_ARTIFACTS_DEST }}
  #         merge-multiple: true

      # - name: Step 3.4 - Extract build artefacts
      #   shell: bash
      #   working-directory: ${{ env.BUILD_ARTIFACTS_DEST }}
      #   run: |
      #     set -euo pipefail
      #     shopt -s nullglob

      #     for tar_arch in *.tar; do
      #       tar -xvf $tar_arch
      #       rm -rf $tar_arch
      #     done;

      #     ls -al ./**

      # - name: Step 3.5 - Load images
      #   shell: bash
      #   working-directory: ${{ env.BUILD_ARTIFACTS_DEST }}
      #   run: |
      #     set -euo pipefail
      #     shopt -s nullglob

      #     for archdir in ./*; do
      #       [ -d "$archdir" ] || continue
            
      #       arch_tag=$(basename $archdir)
      #       echo "::group::Loading images for ${arch_tag}"
      #       ls -al .

      #       for img in "$archdir"/*.docker; do
      #         [ -f "$img" ] || continue

      #         ls -al $img
      #         docker image load -i $img
      #       done
          
      #     done
      #     echo "::endgroup::"

      #     docker image ls

      # - name: Step 3.6 - Create and publish manifests
      #   id: create
      #   shell: bash
      #   working-directory: ${{ env.BUILD_ARTIFACTS_DEST }}
      #   env:
      #     GHCR_NS: ${{ env.GHCR_NS }}
      #     VERSION: ${{ needs.build.outputs.version }}
      #   run: |
      #     declare -a dev_images=()
      #     declare -a dev_slim_images=()
      #     declare -a manifest_summaries=()

      #     create_or_replace_manifest() {
      #       local ref="$1"
      #       shift
      #       local -a images=("$@")

      #       if docker manifest inspect "$ref" >/dev/null 2>&1; then
      #         docker manifest create --amend "$ref" "${images[@]}"
      #       else
      #         docker manifest create "$ref" "${images[@]}"
      #       fi

      #       docker manifest push "$ref"
      #       build_summary_block "$ref"
      #     }

      #     build_summary_block() {
      #       local ref="$1"
      #       local inspect_json
      #       inspect_json="$(docker manifest inspect --verbose "$ref")"

      #       local arches digest
      #       arches="$(jq -r '
      #         (.manifests // [])
      #         | map(
      #             (.platform.os // "linux")
      #             + "/"
      #             + (.platform.architecture // "unknown")
      #             + (if (.platform.variant // "") != "" then "/" + .platform.variant else "")
      #           )
      #         | unique
      #         | join(", ")
      #       ' <<<"$inspect_json")"

      #       digest="$(jq -r '.Descriptor.digest // empty' <<<"$inspect_json")"

      #       if [[ -z "$arches" ]]; then
      #         arches="N/A"
      #       fi
      #       if [[ -z "$digest" ]]; then
      #         digest="N/A"
      #       fi

      #       manifest_summaries+=("<Image> ${ref}"$'\n'"- Architectures: ${arches}"$'\n'"- Digest: ${digest}")
      #     }

      #     for archdir in ./*; do
      #       [ -d "$archdir" ] || continue
      #       arch_tag=$(basename $archdir)

      #       for img in "$archdir"/*.docker; do
      #         [ -f "$img" ] || continue
      #         build_target=$(basename "$img")
              
      #         if [ "$build_target" == "scratch-final.docker" ]; then
      #           dev_slim_images+=("${{ env.GHCR_NS }}:dev-slim-${{ env.VERSION }}-${arch_tag}")
      #         fi;
              
      #         if [ "$build_target" == "alpine-final.docker" ]; then
      #           dev_images+=("${{ env.GHCR_NS }}:dev-${{ env.VERSION }}-${arch_tag}")
      #         fi;
      #       done;
      #     done;

      #     if (( ${#dev_slim_images[@]} > 0 )); then 
      #       create_or_replace_manifest "${{ env.GHCR_NS }}:${{ env.VERSION }}-dev-slim" "${dev_slim_images[@]}"
      #       create_or_replace_manifest "${{ env.GHCR_NS }}:dev-slim" "${dev_slim_images[@]}"
      #     fi

      #     if (( ${#dev_images[@]} > 0 )); then
      #       create_or_replace_manifest "${{ env.GHCR_NS }}:${{ env.VERSION }}-dev" "${dev_images[@]}"
      #       create_or_replace_manifest "${{ env.GHCR_NS }}:dev" "${dev_images[@]}"
      #     fi

      #     if (( ${#manifest_summaries[@]} > 0 )); then
      #       {
      #         echo 'manifest_summary<<EOF'
      #         printf '%s\n\n' "${manifest_summaries[@]}"
      #         echo 'EOF'
      #       } >> "$GITHUB_OUTPUT"
      #     fi

      # - name: Step 3.4 - Summary (manifests)
      #   if: always()
      #   shell: bash
      #   run: |
      #     {
      #       echo "## ðŸ“š Multi-arch manifests"
      #       echo ""
      #       if [[ "${{ steps.create.outcome }}" == "success" ]]; then
      #         echo "âœ… All requested manifests were created."
      #       else
      #         echo "âŒ Manifest creation encountered an error."
      #       fi
      #       echo ""
      #       echo "### ðŸ”– Version"
      #       if [[ -n "${{ needs.build.outputs.version }}" ]]; then
      #         echo "- CHANGELOG version: **${{ needs.build.outputs.version }}**"
      #       else
      #         echo "- CHANGELOG version: *(unavailable)*"
      #       fi
      #       echo ""
      #       echo "### ðŸ·ï¸ Final tags"
      #       echo ""
      #       SUMMARY_OUTPUT='${{ steps.create.outputs.manifest_summary }}'
      #       if [[ -n "$SUMMARY_OUTPUT" ]]; then
      #         printf '%s\n' "$SUMMARY_OUTPUT"
      #       else
      #         echo "- *(no manifest information available)*"
      #       fi
      #       echo ""
      #       echo "### ðŸ“¦ Registry"
      #       echo "- ghcr.io"
      #     } >> "$GITHUB_STEP_SUMMARY"
